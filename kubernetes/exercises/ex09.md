# ğŸ§ª TP â€“ StatefulSets, Headless Services et stockage persistant

## ğŸ§  Objectifs

- DÃ©ployer un StatefulSet avec stockage persistant
- Comprendre le lien entre Pods, PVCs, et le Service headless
- Tester la stabilitÃ© du nom et du volume
- Explorer la rÃ©solution DNS Pod par Pod
- Supprimer un Pod et vÃ©rifier la conservation du volume

---

## ğŸŸ¦ Ã‰tape 1 â€“ CrÃ©er un namespace

```bash
kubectl create namespace tp-statefulset
```

ğŸŸ¦ Ã‰tape 2 â€“ CrÃ©er un service headless

âœ… headless-service.yaml

```yaml
apiVersion: v1
kind: Service
metadata:
  name: web
  namespace: tp-statefulset
spec:
  clusterIP: None
  selector:
    app: web
  ports:
  - port: 80
```

```bash
kubectl apply -f headless-service.yaml
```

ğŸŸ¦ Ã‰tape 3 â€“ DÃ©ployer un StatefulSet

âœ… statefulset.yaml

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
  namespace: tp-statefulset
spec:
  serviceName: web
  replicas: 3
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
      - name: busybox
        image: busybox
        command: ["sh", "-c", "echo $(hostname) > /data/hostname.txt && sleep 3600"]
        volumeMounts:
        - name: data
          mountPath: /data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      resources:
        requests:
          storage: 500Mi
```

```bash
kubectl apply -f statefulset.yaml
```

ğŸŸ¦ Ã‰tape 4 â€“ Observer les objets crÃ©Ã©s

kubectl get pods -n tp-statefulset
kubectl get pvc -n tp-statefulset
kubectl get pv

ğŸ” VÃ©rifie que chaque Pod a son propre PVC nommÃ© data-web-0, data-web-1, etc.

ğŸŸ¦ Ã‰tape 5 â€“ Explorer le contenu dâ€™un volume

```bash
kubectl exec -it web-0 -n tp-statefulset -- cat /data/hostname.txt
```

ğŸ’¡ Tu devrais voir : web-0

ğŸŸ¦ Ã‰tape 6 â€“ Tester la persistance aprÃ¨s suppression

```bash
kubectl delete pod web-0 -n tp-statefulset
kubectl get pods -n tp-statefulset
```

â¡ï¸ Kubernetes va recrÃ©er web-0 automatiquement

```bash
kubectl exec -it web-0 -n tp-statefulset -- cat /data/hostname.txt
```

âœ… Le fichier est toujours lÃ  â le volume est persistant

ğŸŸ¦ Ã‰tape 7 â€“ Tester la rÃ©solution DNS entre Pods

```bash
kubectl exec -it web-0 -n tp-statefulset -- ping web-1.web
```

â¡ï¸ Les Pods peuvent se joindre par nom grÃ¢ce au service headless

âœ… RÃ©capitulatif


| Ã‰lÃ©ment              | Fonction                                   |
|----------------------|--------------------------------------------|
| StatefulSet          | GÃ¨re les Pods avec nom et stockage stables |
| volumeClaimTemplates | GÃ©nÃ¨re un PVC par Pod                      |
| Headless Service     | Permet DNS par Pod (web-0, web-1, ...)     |
| Persistance          | Les donnÃ©es du Pod sont conservÃ©es         |


ğŸ“Œ Les StatefulSets sont essentiels pour les bases de donnÃ©es, clusters distribuÃ©s, et toute application stateful.
