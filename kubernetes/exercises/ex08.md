# ğŸ§ª TP â€“ Le stockage persistant avec PV, PVC, Pod, Deployment et StorageClass

## ğŸ¯ Objectifs pÃ©dagogiques

- CrÃ©er un volume (PV) et le rÃ©clamer (PVC)
- Monter un volume dans un Pod
- Utiliser un PVC dans un Deployment
- Utiliser la StorageClass par dÃ©faut pour un volume dynamique
- Trouver la StorageClass par dÃ©faut et l'observer

---

## ğŸŸ¦ Ã‰tape 1 â€“ PV + PVC + Pod (manuel)

### âœ… pv.yaml
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-manuel
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /tmp/data-manuel
  persistentVolumeReclaimPolicy: Retain
```

### âœ… pvc.yaml
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-manuel
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
```

### âœ… pod.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-pv
spec:
  containers:
  - name: alpine
    image: alpine
    command: ["sh", "-c", "echo Hello > /data/test.txt && sleep 3600"]
    volumeMounts:
    - name: data-volume
      mountPath: /data
  volumes:
  - name: data-volume
    persistentVolumeClaim:
      claimName: pvc-manuel
```

### ğŸ§ª Commandes
```bash
kubectl apply -f pv.yaml
kubectl apply -f pvc.yaml
kubectl get pv,pvc
kubectl apply -f pod.yaml
kubectl exec -it pod-pv -- cat /data/test.txt
```

---

## ğŸŸ¦ Ã‰tape 2 â€“ PVC + Deployment

### âœ… pvc-deploy.yaml
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-deploy
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
```

### âœ… deployment.yaml
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-storage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: storage-demo
  template:
    metadata:
      labels:
        app: storage-demo
    spec:
      containers:
      - name: busy
        image: busybox
        command: [ "sh", "-c", "date >> /data/date.log && sleep 3600" ]
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: pvc-deploy
```

### ğŸ§ª VÃ©rifications

```bash
kubectl apply -f pvc-deploy.yaml
kubectl apply -f deployment.yaml
kubectl get pods
kubectl exec -it <pod> -- cat /data/date.log
```

---

## ğŸŸ¦ Ã‰tape 3 â€“ Utiliser la StorageClass par dÃ©faut

ğŸ¯ Ici, pas besoin de crÃ©er un PV : Kubernetes en crÃ©e un automatiquement.

### âœ… pvc-dynamique.yaml
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-dyn
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
```

### âœ… pod-dyn.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-dyn
spec:
  containers:
  - name: busy
    image: busybox
    command: ["sh", "-c", "echo 'From dynamic PVC' > /data/info.txt && sleep 3600"]
    volumeMounts:
    - name: dyn-vol
      mountPath: /data
  volumes:
  - name: dyn-vol
    persistentVolumeClaim:
      claimName: pvc-dyn
```

### ğŸ§ª Commandes
```bash
kubectl apply -f pvc-dynamique.yaml
kubectl apply -f pod-dyn.yaml
kubectl get pv,pvc
kubectl describe pvc pvc-dyn
```

ğŸ“Œ Le PV est crÃ©Ã© **automatiquement** avec une StorageClass.

---

## ğŸŸ¦ Ã‰tape 4 â€“ Trouver la StorageClass par dÃ©faut

```bash
kubectl get storageclass
```

Tu verras une ligne comme :

```text
NAME            PROVISIONER               RECLAIMPOLICY   VOLUMEâ€¦
standard (*)    csi-hostpath              Delete          Immediate
```

> Lâ€™astÃ©risque `(*)` indique la StorageClass **par dÃ©faut**

ğŸ” Pour plus de dÃ©tails :

```bash
kubectl describe storageclass standard
```

---

## âœ… RÃ©capitulatif

| Ã‰tape       | Stockage             | Provisionnement        |
|-------------|----------------------|------------------------|
| Ã‰tape 1     | PV + PVC             | Manuel                 |
| Ã‰tape 2     | PVC + Deployment     | Manuel (PV requis)     |
| Ã‰tape 3     | PVC seul             | âœ… Auto (StorageClass) |
| Ã‰tape 4     | DÃ©couverte SC        | Via `kubectl get sc`   |
