# ğŸ§ª TP â€“ Ingress avec NGINX Controller ( Kind seulement)

## ğŸ¯ Objectifs pÃ©dagogiques

- DÃ©ployer 2 apps accessibles via le mÃªme Ingress
- Utiliser le routage par chemin (`/app1`, `/app2`)
- Utiliser `ingressClassName`
- VÃ©rifier lâ€™accÃ¨s HTTP via Ingress

## ğŸŸ¦ Ã‰tape 0 â€“ Installer l'ingress Controller

Ouvrir une autre fenÃªte de terminal avec la combinaison de touche `atl-t`

Lancer le founisseur de loabalancer de Kind

```
cloud-provider-kind
```


Revenir dans la fenÃªtre princicpal

```
kubectl apply -f https://kind.sigs.k8s.io/examples/ingress/deploy-ingress-nginx.yaml
```

```
kubectl get pods -n ingress-nginx
```

Voir si le ingress controller est dans un Ã©tat "Running"


```
kubectl get svc -n ingress-nginx
```



---

## ğŸŸ¦ Ã‰tape 1 â€“ CrÃ©er un namespace

```bash
kubectl create namespace tp-ingress
```

---

## ğŸŸ¦ Ã‰tape 2 â€“ DÃ©ployer 2 instances de podinfo

```yaml
# podinfo-app1.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app1
  namespace: tp-ingress
spec:
  replicas: 1
  selector:
    matchLabels:
      app: app1
  template:
    metadata:
      labels:
        app: app1
    spec:
      containers:
      - name: podinfo
        image: stefanprodan/podinfo:6.7.0
        ports:
        - containerPort: 9898
---
apiVersion: v1
kind: Service
metadata:
  name: app1
  namespace: tp-ingress
spec:
  selector:
    app: app1
  ports:
  - port: 80
    targetPort: 9898
```

```yaml
# podinfo-app2.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: app2
  namespace: tp-ingress
spec:
  replicas: 1
  selector:
    matchLabels:
      app: app2
  template:
    metadata:
      labels:
        app: app2
    spec:
      containers:
      - name: podinfo
        image: stefanprodan/podinfo:6.8.0
        ports:
        - containerPort: 9898
---
apiVersion: v1
kind: Service
metadata:
  name: app2
  namespace: tp-ingress
spec:
  selector:
    app: app2
  ports:
  - port: 80
    targetPort: 9898
```

```bash
kubectl apply -f podinfo-app1.yaml
kubectl apply -f podinfo-app2.yaml
```

---

## ğŸŸ¦ Ã‰tape 3 â€“ CrÃ©er lâ€™Ingress

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: podinfo-ingress
  namespace: tp-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: demo.local
    http:
      paths:
      - path: /app1
        pathType: Prefix
        backend:
          service:
            name: app1
            port:
              number: 80
      - path: /app2
        pathType: Prefix
        backend:
          service:
            name: app2
            port:
              number: 80
```

```bash
kubectl apply -f ingress.yaml
```

```bash
kubectl get -n tp-ingress ingress
```

---

## ğŸŸ¦ Ã‰tape 4 â€“ Tester lâ€™accÃ¨s

ğŸ” Obtenir lâ€™adresse IP de lâ€™Ingress Controller :

```bash
kubectl get svc -n ingress-nginx
```



ğŸ“Œ Note lâ€™adresse IP du LoadBalancer ou du NodePort (ex: `172.20.0.3`)

```bash
LOADBALANCER_IP=$(kubectl get services \
   --namespace ingress-nginx \
   ingress-nginx-controller \
   --output jsonpath='{.status.loadBalancer.ingress[0].ip}')
echo "IP du loadbalancer $LOADBALANCER_IP"
```bash

---

### ğŸ§ª Modifier `/etc/hosts`

Ajouter la ligne suivante :
```text
echo "172.20.0.3 demo.local" | sudo tee -a /etc/hosts
```


(âš ï¸ remplace `172.20.0.3` par la vraie IP obtenue)

---

### ğŸ” Tester avec `curl` ou navigateur :

```bash
curl http://demo.local/app1
curl http://demo.local/app2
```

ğŸ’¡ Tu devrais voir le JSON de `podinfo` avec hostname unique et une version diffÃ©rente pour chaque app 

---

## âœ… RÃ©sumÃ©

| Composant       | Fonction                             |
|------------------|--------------------------------------|
| Ingress          | Routage vers 2 services (`/app1`, `/app2`) |
| ingressClassName | DÃ©finit que lâ€™Ingress utilise NGINX |
| Annotations      | Utilise `rewrite-target` pour les chemins |
| Services         | Exposent les Pods de chaque app      |

---
