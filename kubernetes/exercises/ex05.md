# 🧪 TP – Services Kubernetes avec l’image `stefanprodan/podinfo`

## 🎯 Objectifs

- Déployer un Pod avec l’image `podinfo`
- Créer différents types de Services Kubernetes
- Tester les accès réseau et la résolution DNS
- Comprendre les différences entre ClusterIP, NodePort et LoadBalancer

---

## 🟦 Étape 1 – Créer le namespace

```bash
kubectl create namespace tp-services
```

---

## 🟦 Étape 2 – Déployer le Pod `podinfo`

### ✅ `pod.yaml`
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: podinfo
  namespace: tp-services
  labels:
    app: podinfo
spec:
  containers:
  - name: podinfo
    image: stefanprodan/podinfo:6.8.0
    ports:
    - containerPort: 9898
```

```bash
kubectl apply -f pod.yaml
```

---

## 🟦 Étape 3 – Créer un Service de type `ClusterIP`

### ✅ `service-clusterip.yaml`
```yaml
apiVersion: v1
kind: Service
metadata:
  name: podinfo-svc
  namespace: tp-services
spec:
  selector:
    app: podinfo
  ports:
  - port: 80
    targetPort: 9898
    protocol: TCP
```

```bash
kubectl apply -f service-clusterip.yaml
kubectl get svc -n tp-services
```

---

## 🟦 Étape 4 – Tester depuis un Pod dans le même namespace

```bash
kubectl run curl --rm -it --image=curlimages/curl --namespace=tp-services -- sh
```

Depuis le shell :
```bash
curl http://podinfo-svc
```

📌 Résultat attendu :
Réponse JSON du service `podinfo` (version, hostname, etc.)

---

## 🟦 Étape 5 – Créer un Service `NodePort`

### ✅ `service-nodeport.yaml`
```yaml
apiVersion: v1
kind: Service
metadata:
  name: podinfo-nodeport
  namespace: tp-services
spec:
  type: NodePort
  selector:
    app: podinfo
  ports:
  - port: 80
    targetPort: 9898
    nodePort: 30080
```

```bash
kubectl apply -f service-nodeport.yaml
kubectl get svc -n tp-services
```

---

### 🔍 Tester depuis l’extérieur :

```bash
curl http://<IP_NODE>:30080
```

💡 Utilise ` kubectl get nodes -o wide` cherche INTERNAL-IP

---

## 🟦 Étape 6 – Créer un Service `LoadBalancer` (optionnel - cloud only)

### ✅ `service-lb.yaml`
```yaml
apiVersion: v1
kind: Service
metadata:
  name: podinfo-lb
  namespace: tp-services
spec:
  type: LoadBalancer
  selector:
    app: podinfo
  ports:
  - port: 80
    targetPort: 9898
```

```bash
kubectl apply -f service-lb.yaml
kubectl get svc -n tp-services
```

Une fois `EXTERNAL-IP` disponible :
```bash
curl http://<EXTERNAL-IP>
```

---

## 🟦 Étape 7 – Résolution DNS entre namespaces

### ✅ Créer un autre namespace de test

```bash
kubectl create namespace test-dns
```

### ✅ Lancer un Pod client

```bash
kubectl run dns-client --rm -it --image=wbitt/network-multitool  --namespace=test-dns -- /bin/bash
```

---

### 🔍 Tester la résolution DNS  avec curl

```bash
curl podinfo-svc               # ❌ Ne marche pas (nom court, mauvais namespace)
curl  podinfo-svc.tp-services.svc   # ✅ Résout correctement
curl podinfo-svc.tp-services.svc.cluster.local   # ✅ Résout aussi
```


### Regarder la configuration DNS de votre 

```bash
cat /etc/resolv.conf
```


Que pouvez en déduire ?

---

## ✅ Résumé final

| Type de Service | Interne | Externe | DNS                      | Testable avec...           |
|------------------|---------|---------|---------------------------|-----------------------------|
| ClusterIP        | ✅       | ❌       | `svc.namespace`           | `curl` depuis un Pod        |
| NodePort         | ✅       | ✅       | `svc.namespace`           | `curl` via IP du Node       |
| LoadBalancer     | ✅       | ✅       | `svc.namespace`           | `curl` via EXTERNAL-IP      |

---

📌 Image utilisée : [`stefanprodan/podinfo:6.8.0`](https://hub.docker.com/r/stefanprodan/podinfo)  
Port utilisé dans le conteneur : `9898`  
Port exposé par les Services : `80`

