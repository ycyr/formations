# ğŸ§ª TP â€“ Services Kubernetes avec lâ€™image `stefanprodan/podinfo`

## ğŸ¯ Objectifs

- DÃ©ployer un Pod avec lâ€™image `podinfo`
- CrÃ©er diffÃ©rents types de Services Kubernetes
- Tester les accÃ¨s rÃ©seau et la rÃ©solution DNS
- Comprendre les diffÃ©rences entre ClusterIP, NodePort et LoadBalancer

---

## ğŸŸ¦ Ã‰tape 1 â€“ CrÃ©er le namespace

```bash
kubectl create namespace tp-services
```

---

## ğŸŸ¦ Ã‰tape 2 â€“ DÃ©ployer le Pod `podinfo`

### âœ… `pod.yaml`
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: podinfo
  namespace: tp-services
  labels:
    app: podinfo
spec:
  containers:
  - name: podinfo
    image: stefanprodan/podinfo:6.8.0
    ports:
    - containerPort: 9898
```

```bash
kubectl apply -f pod.yaml
```

---

## ğŸŸ¦ Ã‰tape 3 â€“ CrÃ©er un Service de type `ClusterIP`

### âœ… `service-clusterip.yaml`
```yaml
apiVersion: v1
kind: Service
metadata:
  name: podinfo-svc
  namespace: tp-services
spec:
  selector:
    app: podinfo
  ports:
  - port: 80
    targetPort: 9898
    protocol: TCP
```

```bash
kubectl apply -f service-clusterip.yaml
```
```
kubectl get svc -n tp-services
```

---

## ğŸŸ¦ Ã‰tape 4 â€“ Tester depuis un Pod dans le mÃªme namespace

```bash
kubectl run curl --rm -it --image=curlimages/curl --namespace=tp-services -- sh
```

Depuis le shell :
```bash
curl http://podinfo-svc
```




ğŸ“Œ RÃ©sultat attendu :
RÃ©ponse JSON du service `podinfo` (version, hostname, etc.)

Pour sortir du pod
```
exit
```

---

## ğŸŸ¦ Ã‰tape 5 â€“ CrÃ©er un Service `NodePort`

### âœ… `service-nodeport.yaml`
```yaml
apiVersion: v1
kind: Service
metadata:
  name: podinfo-nodeport
  namespace: tp-services
spec:
  type: NodePort
  selector:
    app: podinfo
  ports:
  - port: 80
    targetPort: 9898
    nodePort: 30080
```

```bash
kubectl apply -f service-nodeport.yaml
```
```
kubectl get svc -n tp-services
```

---

### ğŸ” Tester depuis lâ€™extÃ©rieur :


ğŸ’¡ Utilise ` kubectl get nodes -o wide` cherche INTERNAL-IP 

```bash
curl http://<INTERNAL-IP>:30080
```



---

## ğŸŸ¦ Ã‰tape 6 â€“ CrÃ©er un Service `LoadBalancer` 

Ouvrir une autre fenÃªte de terminal avec la combinaison de touche `atl-t`

Lancer le founisseur de loabalancer de Kind

```
cloud-provider-kind
```


Revenir dans votre fenÃªtre de terminal initiale

### âœ… `service-lb.yaml`
```yaml
apiVersion: v1
kind: Service
metadata:
  name: podinfo-lb
  namespace: tp-services
spec:
  type: LoadBalancer
  selector:
    app: podinfo
  ports:
  - port: 80
    targetPort: 9898
```

```bash
kubectl apply -f service-lb.yaml
```
```
kubectl get svc -n tp-services
```

Une fois `EXTERNAL-IP` disponible :
```bash
curl http://<EXTERNAL-IP>
```

Allez voir votre seconde fenÃªtre de terminal pour voir le cloud-provider-kind

---

## ğŸŸ¦ Ã‰tape 7 â€“ RÃ©solution DNS entre namespaces

Revenir dans votre fenÃªtre de terminal initiale

### âœ… CrÃ©er un autre namespace de test

```bash
kubectl create namespace test-dns
```

### âœ… Lancer un Pod client

```bash
kubectl run dns-client --rm -it --image=wbitt/network-multitool  --namespace=test-dns -- /bin/bash
```

---

### ğŸ” Tester la rÃ©solution DNS  avec curl

```
curl podinfo-svc                                 # âŒ Ne marche pas (nom court, mauvais namespace)
```

```
curl podinfo-svc.tp-services.svc                 # âœ… RÃ©sout correctement
```

```
curl podinfo-svc.tp-services.svc.cluster.local   # âœ… RÃ©sout aussi
```


### Regarder la configuration DNS de votre 

```bash
cat /etc/resolv.conf
```



Que pouvez en dÃ©duire ?

Pour sortir du pod
```
exit
```

---

## âœ… RÃ©sumÃ© final

| Type de Service | Interne | Externe | DNS                      | Testable avec...           |
|------------------|---------|---------|---------------------------|-----------------------------|
| ClusterIP        | âœ…       | âŒ       | `svc.namespace`           | `curl` depuis un Pod        |
| NodePort         | âœ…       | âœ…       | `svc.namespace`           | `curl` via IP du Node       |
| LoadBalancer     | âœ…       | âœ…       | `svc.namespace`           | `curl` via EXTERNAL-IP      |

---

## â“ Questions de fin de TP â€“ Services & RÃ©solution DNS
### ğŸ§  Q1 â€“ Analyse du comportement rÃ©seau :

Pourquoi la commande `curl podinfo-svc` fonctionne dans le mÃªme namespace, mais Ã©choue dans un autre namespace sans suffixe DNS complet ?
Que pouvez-vous observer dans le fichier `/etc/resolv.conf` dâ€™un Pod ?

### ğŸ’¬ Q2 â€“ Design rÃ©seau Kubernetes :

Si vous souhaitez quâ€™un service soit accessible uniquement Ã  lâ€™intÃ©rieur du cluster, mais jamais exposÃ© depuis lâ€™extÃ©rieur :
Quel type de Service est le plus adaptÃ©, et pourquoi ne faut-il pas utiliser un NodePort ou un LoadBalancer dans ce cas ?





