# ğŸ§ª TP 2 â€“ ReplicaSet : Haute disponibilitÃ© et gestion des Pods

## ğŸ¯ Objectifs pÃ©dagogiques

- CrÃ©er un ReplicaSet dans un namespace dÃ©diÃ©
- Comprendre lâ€™auto-rÃ©paration des Pods
- Observer le nommage automatique
- Ã‰tudier le comportement vis-Ã -vis des Pods existants
- Constater quâ€™un ReplicaSet ne permet pas de mettre Ã  jour les Pods existants

---

## ğŸŸ¦ Ã‰tape 1 â€“ CrÃ©er un namespace dÃ©diÃ©

```bash
kubectl create namespace tp-replicaset
```

---

## ğŸŸ¦ Ã‰tape 2 â€“ CrÃ©er un ReplicaSet avec 3 Pods

### âœ… Fichier `replicaset.yaml`
```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: web-replicaset
  namespace: tp-replicaset
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
```

```bash
kubectl apply -f replicaset.yaml
```

---

## ğŸŸ¦ Ã‰tape 3 â€“ Observation

```bash
kubectl get pods -n tp-replicaset
```

ğŸ’¡ Les Pods ont des noms comme (la derniÃ¨re partie sera diffÃ©rente):
```
web-replicaset-5g9d7
web-replicaset-x2p4t
web-replicaset-m1k8z
```

> âœ… Le prÃ©fixe = nom du ReplicaSet  
> âœ… Le suffixe = chaÃ®ne alÃ©atoire gÃ©nÃ©rÃ©e automatiquement

---

## ğŸŸ¦ Ã‰tape 4 â€“ DÃ©monstration dâ€™auto-rÃ©paration

### âŒ Supprimer un Pod manuellement (Remplate web-replicaset-xxxxx le nom de l'un de tes pods)
```bash
kubectl delete pod web-replicaset-xxxxx -n tp-replicaset
```

### ğŸ” Observer le comportement
```bash
kubectl get pods -n tp-replicaset 
```

ğŸ’¬ Le ReplicaSet recrÃ©e immÃ©diatement un nouveau Pod pour conserver 3 Pods actifs.

### ğŸ§¹ Nettoyage avant lâ€™exercice suivant
```bash
kubectl delete replicaset web-replicaset -n tp-replicaset
```

---

## ğŸŸ¦ Ã‰tape 5 â€“ CrÃ©er des Pods manuellement + ReplicaSet intelligent

â¡ï¸ On va :
- CrÃ©er 2 Pods avec les mÃªmes labels que le ReplicaSet cible
- CrÃ©er un ReplicaSet avec 3 rÃ©plicas
- Observer que Kubernetes **rÃ©utilise les Pods existants**

---

### âœ… `manuel-1.yaml`
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: manuel-1
  namespace: tp-replicaset
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.21
```

### âœ… `manuel-2.yaml`
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: manuel-2
  namespace: tp-replicaset
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.21
```

```bash
kubectl apply -f manuel-1.yaml
```
```
kubectl apply -f manuel-2.yaml
```
Regarde les pods crÃ©es

```bash
kubectl get pods -n tp-replicaset
```

---

### âœ… `smart-replicaset.yaml`
```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: smart-replicaset
  namespace: tp-replicaset
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
```

```bash
kubectl apply -f smart-replicaset.yaml
```

---

### ğŸ” Observer les Pods
```bash
kubectl get pods -n tp-replicaset -o wide
```

ğŸ’¬ Le ReplicaSet **ne crÃ©e quâ€™un seul nouveau Pod**, car les deux autres existent dÃ©jÃ  et matchent le `selector`.

---

## ğŸŸ¦ Ã‰tape 6 â€“ Mise Ã  jour dâ€™un ReplicaSet âŒ

â¡ï¸ Essayons de modifier lâ€™image pour passer Ã  une autre version de nginx :

```yaml
spec:
  template:
    spec:
      containers:
      - name: nginx
        image: nginx:1.25  <-----
```

```bash
kubectl apply -f smart-replicaset.yaml
```
```
kubectl get pods -n tp-replicaset
```

### ğŸ˜® RÃ©sultat :
- **Les anciens Pods ne sont pas mis Ã  jour !**
- Le ReplicaSet **ne remplace pas** les Pods existants

---

### âœ… Pourquoi ?
> Un ReplicaSet **nâ€™est pas conÃ§u pour faire des mises Ã  jour**.  
> Pour cela, il faut utiliser un **Deployment** qui gÃ¨re les rolling updates.

## ğŸŸ¦ Ã‰tape 7 â€“ Nettoyage

```bash
kubectl delete ns tp-replicaset
```

---

## âœ… RÃ©capitulatif

| Action                                     | RÃ©sultat attendu                                         |
|--------------------------------------------|----------------------------------------------------------|
| CrÃ©ation de ReplicaSet                     | Pods crÃ©Ã©s automatiquement                              |
| Suppression dâ€™un Pod                       | Le ReplicaSet le recrÃ©e                                 |
| CrÃ©ation de Pods manuels                   | Le ReplicaSet les adopte sâ€™ils matchent le `selector`   |
| CrÃ©ation du ReplicaSet ensuite             | Il complÃ¨te pour atteindre le nombre voulu              |
| Tentative de mise Ã  jour                   | âŒ Les Pods ne sont pas mis Ã  jour                      |
| Solution recommandÃ©e                       | âœ… Utiliser un `Deployment` pour les mises Ã  jour        |
```
