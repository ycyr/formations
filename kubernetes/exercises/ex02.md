# üß™ TP 2 ‚Äì ReplicaSet : Haute disponibilit√© et gestion des Pods

## üéØ Objectifs p√©dagogiques

- Cr√©er un ReplicaSet dans un namespace d√©di√©
- Comprendre l‚Äôauto-r√©paration des Pods
- Observer le nommage automatique
- √âtudier le comportement vis-√†-vis des Pods existants
- Constater qu‚Äôun ReplicaSet ne permet pas de mettre √† jour les Pods existants

---

## üü¶ √âtape 1 ‚Äì Cr√©er un namespace d√©di√©

```bash
kubectl create namespace tp-replicaset
```

---

## üü¶ √âtape 2 ‚Äì Cr√©er un ReplicaSet avec 3 Pods

### ‚úÖ Fichier `replicaset.yaml`
```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: web-replicaset
  namespace: tp-replicaset
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
```

```bash
kubectl apply -f replicaset.yaml
```

---

## üü¶ √âtape 3 ‚Äì Observation

```bash
kubectl get pods -n tp-replicaset
```

üí° Les Pods ont des noms comme (la derni√®re partie sera diff√©rente):
```
web-replicaset-5g9d7
web-replicaset-x2p4t
web-replicaset-m1k8z
```

> ‚úÖ Le pr√©fixe = nom du ReplicaSet  
> ‚úÖ Le suffixe = cha√Æne al√©atoire g√©n√©r√©e automatiquement

---

## üü¶ √âtape 4 ‚Äì D√©monstration d‚Äôauto-r√©paration

### ‚ùå Supprimer un Pod manuellement (Remplate web-replicaset-xxxxx le nom de l'un de tes pods)
```bash
kubectl delete pod web-replicaset-xxxxx -n tp-replicaset
```

### üîç Observer le comportement
```bash
kubectl get pods -n tp-replicaset -w
```

üí¨ Le ReplicaSet recr√©e imm√©diatement un nouveau Pod pour conserver 3 Pods actifs.

### üßπ Nettoyage avant l‚Äôexercice suivant
```bash
kubectl delete replicaset web-replicaset -n tp-replicaset
```

---

## üü¶ √âtape 5 ‚Äì Cr√©er des Pods manuellement + ReplicaSet intelligent

‚û°Ô∏è On va :
- Cr√©er 2 Pods avec les m√™mes labels que le ReplicaSet cible
- Cr√©er un ReplicaSet avec 3 r√©plicas
- Observer que Kubernetes **r√©utilise les Pods existants**

---

### ‚úÖ `manuel-1.yaml`
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: manuel-1
  namespace: tp-replicaset
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.21
```

### ‚úÖ `manuel-2.yaml`
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: manuel-2
  namespace: tp-replicaset
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.21
```

```bash
kubectl apply -f manuel-1.yaml
kubectl apply -f manuel-2.yaml
```
Regarde les pods cr√©es

```bash
kubectl get pods -n tp-replicaset
```

---

### ‚úÖ `smart-replicaset.yaml`
```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: smart-replicaset
  namespace: tp-replicaset
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
```

```bash
kubectl apply -f smart-replicaset.yaml
```

---

### üîç Observer les Pods
```bash
kubectl get pods -n tp-replicaset -o wide
```

üí¨ Le ReplicaSet **ne cr√©e qu‚Äôun seul nouveau Pod**, car les deux autres existent d√©j√† et matchent le `selector`.

---

## üü¶ √âtape 6 ‚Äì Mise √† jour d‚Äôun ReplicaSet ‚ùå

‚û°Ô∏è Essayons de modifier l‚Äôimage pour passer √† une autre version :

```yaml
spec:
  template:
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
```

```bash
kubectl apply -f smart-replicaset.yaml
kubectl get pods -n tp-replicaset
```

### üòÆ R√©sultat :
- **Les anciens Pods ne sont pas mis √† jour !**
- Le ReplicaSet **ne remplace pas** les Pods existants

---

### ‚úÖ Pourquoi ?
> Un ReplicaSet **n‚Äôest pas con√ßu pour faire des mises √† jour**.  
> Pour cela, il faut utiliser un **Deployment** qui g√®re les rolling updates.

## üü¶ √âtape 7 ‚Äì Nettoyage

```bash
kubectl delete ns tp-replicaset
```

---

## ‚úÖ R√©capitulatif

| Action                                     | R√©sultat attendu                                         |
|--------------------------------------------|----------------------------------------------------------|
| Cr√©ation de ReplicaSet                     | Pods cr√©√©s automatiquement                              |
| Suppression d‚Äôun Pod                       | Le ReplicaSet le recr√©e                                 |
| Cr√©ation de Pods manuels                   | Le ReplicaSet les adopte s‚Äôils matchent le `selector`   |
| Cr√©ation du ReplicaSet ensuite             | Il compl√®te pour atteindre le nombre voulu              |
| Tentative de mise √† jour                   | ‚ùå Les Pods ne sont pas mis √† jour                      |
| Solution recommand√©e                       | ‚úÖ Utiliser un `Deployment` pour les mises √† jour        |
```
