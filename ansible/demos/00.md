---

### 🔐 **Slide 1 – Connexion SSH sans mot de passe**
Objectif :  
➡️ Permettre à Ansible (agentless) de se connecter **sans mot de passe** à ses cibles via **SSH**  
➡️ Établir une **relation de confiance** entre le nœud de contrôle (`ubuntu-c`) et les hôtes cibles (`ubuntu1`, `centos1`, etc.)

---

### 🔄 **Slide 2 – Comment fonctionne SSH**
Étapes d’une connexion SSH :
1. Échange de versions du protocole
2. Négociation cryptographique (Diffie-Hellman)
3. Vérification de l’empreinte (fingerprint)
4. Échange de clés de session
5. Ouverture d’un canal chiffré
6. Authentification (mot de passe ou clé privée)

---

### 📂 **Slide 3 – Dossier .ssh et known_hosts**
- Les empreintes des hôtes sont enregistrées dans `~/.ssh/known_hosts`
- Visible avec :
```bash
ls -a ~/.ssh
cat ~/.ssh/known_hosts
```
- Chaque hôte peut apparaître sous deux formes : **nom d’hôte** et **adresse IP**

---

### 🔑 **Slide 4 – Passage aux clés SSH**
Problème : entrer un mot de passe manuellement à chaque connexion  
Solution : **authentification par clé SSH**

Sur le nœud de contrôle :
```bash
ssh-keygen
```
- Génère une paire de clés publique/privée dans `~/.ssh`
- Clé publique → `id_rsa.pub`
- Clé privée → `id_rsa`

---

### 📤 **Copie de la clé avec `ssh-copy-id`**
Pour installer automatiquement la clé publique :
```bash
ssh-copy-id ansible@ubuntu1
```
✅ Gère aussi les permissions sur `.ssh/authorized_keys`

Résultat :
- Plus de saisie de mot de passe nécessaire
- Canal sécurisé + authentification automatique

---

### 🔄 **Automatiser avec `sshpass`**
Installer `sshpass` :
```bash
sudo apt update
sudo apt install sshpass
```
Créer un fichier mot de passe :
```bash
echo password > password.txt
```

---

### 🔁 **Script automatisé pour tous les hôtes**
Créer le fichier script-ssh.sh
```bash
#!/bin/bash
for user in ansible root; do
  for os in ubuntu centos; do
    for i in 1 2 3; do
      sshpass -f password.txt ssh-copy-id \
        -o StrictHostKeyChecking=no \
        ${user}@${os}${i}
    done
  done
done
```

🧼 Nettoyage :
```bash
bash -x ./script-ssh.sh
rm password.txt
```

---

### ✅ **Vérification avec Ansible**
Test avec le module `ping` :
```bash
ansible -i ubuntu1,ubuntu2,ubuntu3,centos1,centos2,centos3 all -m ping
```

Résultat :
- Réponse `pong` si la connexion fonctionne
- Confirmation que la connectivité SSH sans mot de passe est bien en place

---

### 🔄 **À retenir**
- SSH est la **colonne vertébrale d’Ansible**
- Clés publiques/privées évitent les mots de passe
- `ssh-copy-id` + `sshpass` = gain de temps énorme
- Possibilité de vérifier rapidement avec `ansible -m ping`

